!function(e){function t(){d.getCommentsList(c,a).then(n),a+=c}function n(e){e.map(function(e){var t=o(l,e);if(s.append(t),e.children.length>0){var n=t.find(".comment-children");e.children.map(function(e){n.append(o(l,e,"comment--child"))})}})}function o(e,t,n){var o=e.clone().attr("id","comment-"+t.id);n&&o.addClass(n),t.author.id!==i&&(o.find(".comment-delete").remove(),o.find(".comment-edit").remove());var m=new Date(t.created_at),a='<i class="fa fa-clock-o"></i> <b>'+m.getYear()+"-"+("0"+m.getMonth()).slice(-2)+"-"+("0"+m.getDate()).slice(-2)+"</b> at <b>"+m.getHours()+":"+m.getMinutes()+"</b>";return o.data("id",t.id),o.find(".comment-author").text(t.author.name),o.find(".comment-avatar").css("background-image","url("+t.author.avatar+")"),o.find(".comment-content").text(t.content),o.find(".comment-posted").html(a),o.show(),o}function m(e){return function(t){t.preventDefault();var n=t.target.elements,o=+n.id.value,m=+n.parent.value,a={content:n.content.value,parent:0!==m?m:null};if(a.content.length>1){var c=o?d.editComment.bind(d):d.addComment.bind(d);o&&(a.id=o),c(a).done(function(n){e&&e(n),t.target.reset()})}else alert("The comment is too short!")}}var a=0,c=5,i=1,r=e("#comments"),l=e("#comment_tpl"),s=e(".commentsList"),d={api_url:"http://frontend-test.pingbull.com/pages/ruslan@lobarev.com/comments",getCommentsList:function(t,n){return e.get({url:this.api_url,dateType:"json"},{count:t||5,offset:n||0})},addComment:function(t){return e.ajax({url:this.api_url,type:"POST",dateType:"json",data:t})},deleteComment:function(t){return e.ajax({url:this.api_url+"/"+t,type:"POST",dateType:"json",data:{_method:"DELETE"}})},editComment:function(t){return e.ajax({url:this.api_url+"/"+t.id,type:"POST",dateType:"json",data:{_method:"PUT",content:t.content,parent:t.parent}})},getComment:function(t){return e.get({url:this.api_url+"/"+t,dateType:"json"})}};e("#app_comments_form").on("submit",m(function(e){s.prepend(o(l,e))})),e(r).on("click",".js-delete-comment",function(t){t.preventDefault();var n=e(this).closest(".comment"),o=n.data("id");window.confirm("Are you sure you want to delete you comment?")&&d.deleteComment(o).then(function(){n.remove()})}),e(r).on("click",".js-show-reply",function(t){t.preventDefault();var n=e(this).closest(".comment"),a=n.find(".comment-replyForm").first(),c=e("#app_comments_form").clone().attr("id",""),i=e("<a>").addClass("comment-closeReplyForm js-close-reply-form").html('<i class="fa fa-close"></i> Cancel');c[0].elements.parent.value=n.data("id"),c[0].elements.content.value="",e(".comment-replyForm").html(""),a.append(i).append(c),c.on("submit",m(function(e){i.trigger("click"),n.find(".comment-children").first().append(o(l,e,"comment--child"))}))}),e(r).on("click",".js-edit-comment",function(t){t.preventDefault();var n=e(this).closest(".comment"),o=n.find(".comment-replyForm").first(),a=n.data("id"),c=e("#app_comments_form").clone().attr("id",""),i=e("<a>").addClass("comment-closeReplyForm js-close-reply-form").html('<i class="fa fa-close"></i> Cancel');c.find("button").text("Edit comment"),e(".comment-replyForm").html(""),o.append(i).append(c),d.getComment(a).then(function(e){c[0].elements.id.value=e.id,c[0].elements.parent.value=e.parent,c[0].elements.content.value=e.content,c.on("submit",m(function(e){i.trigger("click"),n.find(".comment-content").text(e.content)}))})}),e(r).on("click",".js-load-more-comments",function(e){e.preventDefault(),t()}),e(r).on("click",".js-close-reply-form",function(t){t.preventDefault(),e(this).closest(".comment-replyForm").html("")}),t()}($);