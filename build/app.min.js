!function(t){function e(){d.getCommentsList(c,a).then(n),a+=c}function n(t){t.map(function(t){var e=o(l,t);if(s.append(e),t.children.length>0){var n=e.find(".comment-children");t.children.map(function(t){n.append(o(l,t,"comment--child"))})}})}function o(t,e,n){var o=t.clone().attr("id","comment-"+e.id);n&&o.addClass(n),e.author.id!==i&&(o.find(".comment-delete").remove(),o.find(".comment-edit").remove());var m=new Date(e.created_at),a='<i class="fa fa-clock-o"></i> <b>'+m.getYear()+"-"+("0"+m.getMonth()).slice(-2)+"-"+("0"+m.getDate()).slice(-2)+"</b> at <b>"+m.getHours()+":"+m.getMinutes()+"</b>";return o.data("id",e.id),o.find(".comment-author").text(e.author.name),o.find(".comment-avatar").css("background-image","url("+e.author.avatar+")"),o.find(".comment-content").text(e.content),o.find(".comment-posted").html(a),o.show(),o}function m(t){return function(e){e.preventDefault();var n=e.target.elements,o=+n.id.value,m=+n.parent.value,a={content:n.content.value,parent:0!==m?m:null};if(a.content.length>5){var c=o?d.editComment.bind(d):d.addComment.bind(d);o&&(a.id=o),c(a).done(function(n){t&&t(n),e.target.reset()})}}}var a=0,c=5,i=1,r=t("#comments"),l=t("#comment_tpl"),s=t(".commentsList"),d={api_url:"http://frontend-test.pingbull.com/pages/ruslan@lobarev.com/comments",getCommentsList:function(e,n){return t.get({url:this.api_url,dateType:"json"},{count:e||5,offset:n||0})},addComment:function(e){return t.ajax({url:this.api_url,type:"POST",dateType:"json",data:e})},deleteComment:function(e){return t.ajax({url:this.api_url+"/"+e,type:"POST",dateType:"json",data:{_method:"DELETE"}})},editComment:function(e){return t.ajax({url:this.api_url+"/"+e.id,type:"POST",dateType:"json",data:{_method:"PUT",content:e.content,parent:e.parent}})},getComment:function(e){return t.get({url:this.api_url+"/"+e,dateType:"json"})}};t("#app_comments_form").on("submit",m(function(t){s.prepend(o(l,t))})),t(r).on("click",".js-delete-comment",function(e){e.preventDefault();var n=t(this).closest(".comment"),o=n.data("id");d.deleteComment(o).then(function(){confirm("Are you sure you want to delete you comment?")&&n.remove()})}),t(r).on("click",".js-show-reply",function(e){e.preventDefault();var n=t(this).closest(".comment"),a=n.find(".comment-replyForm").first(),c=t("#app_comments_form").clone().attr("id",""),i=t("<a>").addClass("comment-closeReplyForm js-close-reply-form").html('<i class="fa fa-close"></i> Cancel');c[0].elements.parent.value=n.data("id"),c[0].elements.content.value="",t(".comment-replyForm").html(""),a.append(i).append(c),c.on("submit",m(function(t){i.trigger("click"),n.find(".comment-children").first().append(o(l,t,"comment--child"))}))}),t(r).on("click",".js-edit-comment",function(e){e.preventDefault();var n=t(this).closest(".comment"),o=n.find(".comment-replyForm").first(),a=n.data("id"),c=t("#app_comments_form").clone().attr("id",""),i=t("<a>").addClass("comment-closeReplyForm js-close-reply-form").html('<i class="fa fa-close"></i> Cancel');c.find("button").text("Edit comment"),t(".comment-replyForm").html(""),o.append(i).append(c),d.getComment(a).then(function(t){c[0].elements.id.value=t.id,c[0].elements.parent.value=t.parent,c[0].elements.content.value=t.content,c.on("submit",m(function(t){i.trigger("click"),n.find(".comment-content").text(t.content)}))})}),t(r).on("click",".js-load-more-comments",function(t){t.preventDefault(),e()}),t(r).on("click",".js-close-reply-form",function(e){e.preventDefault(),t(this).closest(".comment-replyForm").html("")}),e()}($);