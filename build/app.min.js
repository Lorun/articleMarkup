!function(t){function e(){d.getCommentsList(c,m).then(n),m+=c}function n(t){t.map(function(t){var e=o(l,t);if(s.append(e),t.children.length>0){var n=e.find(".comment-children");t.children.map(function(e){n.append(o(l,e,"comment--child",t.author.name))})}})}function o(t,e,n,o){var a=t.clone().attr("id","comment-"+e.id);n&&a.addClass(n),e.author.id!==r&&(a.find(".comment-delete").remove(),a.find(".comment-edit").remove());var m=new Date(e.created_at),c='<i class="fa fa-clock-o"></i> <b>'+m.getYear()+"-"+("0"+m.getMonth()).slice(-2)+"-"+("0"+m.getDate()).slice(-2)+"</b> at <b>"+m.getHours()+":"+m.getMinutes()+"</b>",i=a.find(".comment-author");return i.text(e.author.name),o&&i.after('<span class="comment-parentAuthor"><i class="fa fa-share"></i> '+o+"</span>"),a.data("id",e.id),a.find(".comment-avatar").css("background-image","url("+e.author.avatar+")"),a.find(".comment-content").text(e.content),a.find(".comment-posted").html(c),a.show(),a}function a(t){return function(e){e.preventDefault();var n=e.target.elements,o=+n.id.value,a=+n.parent.value,m={content:n.content.value,parent:0!==a?a:null};if(m.content.length>5){var c=o?d.editComment.bind(d):d.addComment.bind(d);o&&(m.id=o),c(m).done(function(n){t&&t(n),e.target.reset()})}}}var m=0,c=5,r=1,i=t("#comments"),l=t("#comment_tpl"),s=t(".commentsList"),d={api_url:"http://frontend-test.pingbull.com/pages/ruslan@lobarev.com/comments",getCommentsList:function(e,n){return t.get({url:this.api_url,dateType:"json"},{count:e||5,offset:n||0})},addComment:function(e){return t.ajax({url:this.api_url,type:"POST",dateType:"json",data:e})},deleteComment:function(e){return t.ajax({url:this.api_url+"/"+e,type:"POST",dateType:"json",data:{_method:"DELETE"}})},editComment:function(e){return t.ajax({url:this.api_url+"/"+e.id,type:"POST",dateType:"json",data:{_method:"PUT",content:e.content,parent:e.parent}})},getComment:function(e){return t.get({url:this.api_url+"/"+e,dateType:"json"})}};t("#app_comments_form").on("submit",a(function(t){s.prepend(o(l,t))})),t(i).on("click",".js-delete-comment",function(e){e.preventDefault();var n=t(this).closest(".comment"),o=n.data("id");d.deleteComment(o).then(function(){confirm("Are you sure you want to delete you comment?")&&n.remove()})}),t(i).on("click",".js-show-reply",function(e){e.preventDefault();var n=t(this).closest(".comment"),m=n.find(".comment-replyForm").first(),c=t("#app_comments_form").clone().attr("id",""),r=t("<a>").addClass("comment-closeReplyForm js-close-reply-form").html('<i class="fa fa-close"></i> Cancel');c[0].elements.parent.value=n.data("id"),c[0].elements.content.value="",t(".comment-replyForm").html(""),m.append(r).append(c),console.log(n.find(".comment-author").text()),c.on("submit",a(function(t){r.trigger("click"),n.find(".comment-children").first().append(o(l,t,"comment--child",n.find(".comment-author").text()))}))}),t(i).on("click",".js-edit-comment",function(e){e.preventDefault();var n=t(this).closest(".comment"),o=n.find(".comment-replyForm").first(),m=n.data("id"),c=t("#app_comments_form").clone().attr("id",""),r=t("<a>").addClass("comment-closeReplyForm js-close-reply-form").html('<i class="fa fa-close"></i> Cancel');c.find("button").text("Edit comment"),t(".comment-replyForm").html(""),o.append(r).append(c),d.getComment(m).then(function(t){c[0].elements.id.value=t.id,c[0].elements.parent.value=t.parent,c[0].elements.content.value=t.content,c.on("submit",a(function(t){r.trigger("click"),n.find(".comment-content").text(t.content)}))})}),t(i).on("click",".js-load-more-comments",function(t){t.preventDefault(),e()}),t(i).on("click",".js-close-reply-form",function(e){e.preventDefault(),t(this).closest(".comment-replyForm").html("")}),e()}($);